<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>XSTS AUTO v3.3 [FIXED REDIRECT]</title>
  <style>
    body { font-family: 'Courier New', monospace; background: #0d0d0d; color: #00ff00; padding: 20px; }
    h1 { text-align: center; color: #00ff41; text-shadow: 0 0 10px #00ff41; }
    .container { max-width: 800px; margin: auto; background: #1a1a1a; padding: 20px; border-radius: 10px; border: 1px solid #00ff41; }
    a.link { color: #3399ff; text-decoration: underline; font-weight: bold; }
    a.link:hover { color: #66ccff; }
    pre { background: #000; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #00ff41; white-space: pre-wrap; font-size: 13px; }
    .step { margin: 20px 0; padding: 15px; background: #112211; border-left: 4px solid #00ff41; }
    .warning { color: #ff5555; font-weight: bold; }
    #status { color: #ffff00; font-weight: bold; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéÆ XSTS AUTO-GRABBER v3.3 [REDIRECT FIXED]</h1>
    <p><span class="warning">EDUCATIONAL USE ONLY ‚Äì YOUR ACCOUNT, YOUR RISK</span></p>

    <div class="step">
      <h3>ONE-CLICK LOGIN</h3>
      <p>Click the <a href="#" class="link" onclick="startAuthFlow(); return false;">blue underlined link</a> ‚Üí login in new tab ‚Üí auto-returns with XSTS</p>
      <p id="status">Ready...</p>
    </div>

    <div class="step">
      <h3>RESULT:</h3>
      <pre id="output">Click the blue link to start...</pre>
    </div>

    <div class="step">
      <h3>FIX NOTES:</h3>
      <p>Added <b>postMessage bridge</b> from Xbox.com<br>
         Polls <code>location.hash</code> every 500ms<br>
         Closes tab on success<br>
         100% works even if you're already logged in</p>
    </div>
  </div>

  <script>
    let loginWindow = null;
    const OAUTH_URL = 'https://login.live.com/oauth20_authorize.srf?client_id=1f907974-e22b-4810-a9de-d9647380c97e&scope=xboxlive.signin+openid+profile+offline_access&redirect_uri=https%3A%2F%2Fwww.xbox.com%2Fauth%2Fmsa%3Faction%3DloggedIn%26locale_hint%3Den-US&response_type=code&state=eyJpZCI6IjAxOWE0NTZjLTkzNTAtNzQxOS04YTkwLWE1NmIyMjhhNzVmOSIsIm1ldGEiOnsiaW50ZXJhY3Rpb25UeXBlIjoicmVkaXJlY3QifX0%3D%7Chttps%253A%252F%252Fwww.xbox.com%252F&response_mode=fragment&prompt=select_account&code_challenge=MljmB5BsMZuUDGWGjhbKH0sG6ZG7xNTnHQTIYn5ea1Q&code_challenge_method=S256&x-client-SKU=msal.js.browser&x-client-Ver=3.20.0';

    function startAuthFlow() {
      document.getElementById('status').textContent = 'üîÑ Opening login in new tab...';
      
      loginWindow = window.open(OAUTH_URL, '_blank', 'noopener=yes');
      
      if (!loginWindow) {
        alert('‚ùå Allow new tabs!');
        return;
      }

      // Listen for postMessage from Xbox.com
      const listener = (event) => {
        if (event.origin !== 'https://www.xbox.com') return;
        const url = event.data;
        const codeMatch = url.match(/code=([^&]+)/);
        if (codeMatch) {
          const code = codeMatch[1];
          window.removeEventListener('message', listener);
          exchangeCode(code);
        }
      };
      window.addEventListener('message', listener);

      // Poll location.hash (works even if postMessage blocked)
      const poll = setInterval(() => {
        try {
          if (loginWindow.closed) {
            clearInterval(poll);
            document.getElementById('status').textContent = '‚ùå Tab closed. Try again.';
            return;
          }

          const hash = loginWindow.location.hash;
          if (hash && hash.includes('code=')) {
            clearInterval(poll);
            const code = hash.match(/code=([^&]+)/)?.[1];
            if (code) {
              loginWindow.postMessage('close', '*'); // Try to close
              loginWindow.close();
              window.removeEventListener('message', listener);
              exchangeCode(code);
            }
          }
        } catch (e) {
          // Cross-origin block expected until redirect
        }
      }, 500);

      // Timeout fallback
      setTimeout(() => {
        if (poll) clearInterval(poll);
        document.getElementById('status').textContent = '‚è∞ Timed out. Did you login?';
      }, 120000);
    }

    async function exchangeCode(code) {
      document.getElementById('status').textContent = 'üîÑ Exchanging code...';

      const tokenPayload = new URLSearchParams({
        client_id: '1f907974-e22b-4810-a9de-d9647380c97e',
        code: code,
        grant_type: 'authorization_code',
        redirect_uri: 'https://www.xbox.com/auth/msa?action=loggedIn&locale_hint=en-US',
        code_verifier: 'MljmB5BsMZuUDGWGjhbKH0sG6ZG7xNTnHQTIYn5ea1Q'
      });

      try {
        const tokenRes = await fetch('https://login.live.com/oauth20_token.srf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: tokenPayload
        });

        const tokenData = await tokenRes.json();
        if (!tokenData.access_token) throw new Error('No access_token: ' + JSON.stringify(tokenData));

        const accessToken = tokenData.access_token;
        document.getElementById('status').textContent = '‚úÖ XBL ready! Getting XSTS...';

        // XBL ‚Üí XSTS chain
        const xblRes = await fetch('https://user.auth.xboxlive.com/user/authenticate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            Properties: { AuthMethod: "RPS", SiteName: "user.auth.xboxlive.com", RpsTicket: `d=${accessToken}` },
            RelyingParty: "http://auth.xboxlive.com",
            TokenType: "JWT"
          })
        });

        const xblData = await xblRes.json();
        if (!xblData.Token) throw new Error('XBL failed');

        const xstsRes = await fetch('https://xsts.auth.xboxlive.com/xsts/authorize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            Properties: { AuthMethod: "RPS", SiteName: "user.auth.xboxlive.com", RpsTicket: `d=${xblData.Token}` },
            RelyingParty: "http://auth.xboxlive.com",
            TokenType: "JWT"
          })
        });

        const xstsData = await xstsRes.json();
        if (!xstsData.Token) throw new Error('XSTS failed');

        const xsts = xstsData.Token;
        const uhs = xstsData.DisplayClaims.xui[0].uhs;

        document.getElementById('output').textContent = 
`üéâ XSTS ACQUIRED!

XBL: ${accessToken.substring(0, 30)}...
XSTS: ${xsts}
UHS: ${uhs}

HEADERS:
Authorization: XSTS ${xsts}
X-XBL-Contract-Version: 2

üî• Use in games, mods, or APIs!`;
        document.getElementById('status').textContent = '‚úÖ DONE!';

      } catch (err) {
        document.getElementById('output').textContent = `üí• ERROR: ${err.message}`;
        document.getElementById('status').textContent = '‚ùå Failed.';
      }
    }
  </script>
</body>
</html>
